"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[956],{1804:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"persistence","title":"Persistence Configuration","description":"SAM requires persistent storage for session data and artifacts. This page covers all persistence-related configuration options.","source":"@site/docs/persistence.md","sourceDirName":".","slug":"/persistence","permalink":"/solace-agent-mesh-helm-quickstart/docs/persistence","draft":false,"unlisted":false,"editUrl":"https://github.com/SolaceProducts/solace-agent-mesh-helm-quickstart/edit/main/docs/persistence.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Persistence Configuration"},"sidebar":"tutorialSidebar","previous":{"title":"Network Configuration","permalink":"/solace-agent-mesh-helm-quickstart/docs/network-configuration"},"next":{"title":"Standalone Agent Deployment","permalink":"/solace-agent-mesh-helm-quickstart/docs/standalone-agent-deployment"}}');var i=n(4848),t=n(8453);const a={sidebar_position:3,title:"Persistence Configuration"},o="Persistence Configuration",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Option 1: Bundled Persistence (Dev/POC Only)",id:"option-1-bundled-persistence-devpoc-only",level:2},{value:"Basic Configuration",id:"basic-configuration",level:3},{value:"Image Registry Configuration",id:"image-registry-configuration",level:3},{value:"Using Solace&#39;s Private GCR Registry",id:"using-solaces-private-gcr-registry",level:4},{value:"Custom or Self-Managed Images",id:"custom-or-self-managed-images",level:4},{value:"Storage Class Configuration",id:"storage-class-configuration",level:3},{value:"Important Caveats",id:"important-caveats",level:3},{value:"Option 2: External Persistence (Production Recommended)",id:"option-2-external-persistence-production-recommended",level:2},{value:"Database Requirements",id:"database-requirements",level:3},{value:"Basic External Configuration",id:"basic-external-configuration",level:3},{value:"Provider-Specific Examples",id:"provider-specific-examples",level:3},{value:"Supabase with Connection Pooler",id:"supabase-with-connection-pooler",level:4},{value:"AWS RDS + S3",id:"aws-rds--s3",level:4},{value:"NeonDB",id:"neondb",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Init Container Stuck in Pending/CrashLoopBackOff",id:"init-container-stuck-in-pendingcrashloopbackoff",level:3},{value:"PVC Stuck in Pending",id:"pvc-stuck-in-pending",level:3},{value:"Docker Hub Rate Limit Errors",id:"docker-hub-rate-limit-errors",level:3}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"persistence-configuration",children:"Persistence Configuration"})}),"\n",(0,i.jsx)(s.p,{children:"SAM requires persistent storage for session data and artifacts. This page covers all persistence-related configuration options."}),"\n",(0,i.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(s.p,{children:"SAM uses two types of persistent storage:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"PostgreSQL Database"}),": Stores session metadata, user data, and application state"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"S3-Compatible Storage"}),": Stores artifacts, files, and other binary data"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"You can choose between two persistence strategies:"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Strategy"}),(0,i.jsx)(s.th,{children:"Use Case"}),(0,i.jsx)(s.th,{children:"Components"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.strong,{children:"Bundled Persistence"})}),(0,i.jsx)(s.td,{children:"Development, demos, POC"}),(0,i.jsx)(s.td,{children:"In-cluster PostgreSQL + SeaweedFS"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.strong,{children:"External Persistence"})}),(0,i.jsx)(s.td,{children:"Production deployments"}),(0,i.jsx)(s.td,{children:"Managed PostgreSQL + S3 (e.g., AWS RDS, Supabase, NeonDB)"})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"option-1-bundled-persistence-devpoc-only",children:"Option 1: Bundled Persistence (Dev/POC Only)"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Not recommended for production."})," The chart can deploy single-instance PostgreSQL and SeaweedFS for quick start, demos, and proof-of-concept deployments."]}),"\n",(0,i.jsx)(s.h3,{id:"basic-configuration",children:"Basic Configuration"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'global:\n  persistence:\n    enabled: true\n    namespaceId: "my-sam-instance"  # Must be unique per SAM installation\n'})}),"\n",(0,i.jsx)(s.h3,{id:"image-registry-configuration",children:"Image Registry Configuration"}),"\n",(0,i.jsx)(s.p,{children:"By default, the bundled persistence components pull images from Docker Hub:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["PostgreSQL: ",(0,i.jsx)(s.code,{children:"postgres:18.0"})]}),"\n",(0,i.jsxs)(s.li,{children:["SeaweedFS: ",(0,i.jsx)(s.code,{children:"chrislusf/seaweedfs:3.97"})]}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"using-solaces-private-gcr-registry",children:"Using Solace's Private GCR Registry"}),"\n",(0,i.jsx)(s.p,{children:"To avoid Docker Hub rate limits or when deploying in air-gapped environments, you can use Solace's private GCR registry. When using any of Solace's GCR registries, you must specify GCR-specific image tags:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'global:\n  imageRegistry: gcr.io/gcp-maas-prod\n  persistence:\n    enabled: true\n    namespaceId: "my-sam-instance"\n\nsamDeployment:\n  imagePullSecret: "your-image-pull-secret"  # Required - see Step 2 in Getting Started\n\npersistence-layer:\n  postgresql:\n    image:\n      tag: "18.0-trixie"  # Required for GCR (Docker Hub default: "18.0")\n  seaweedfs:\n    image:\n      tag: "3.97-compliant"  # Required for GCR (Docker Hub default: "3.97")\n'})}),"\n",(0,i.jsxs)(s.blockquote,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Note"}),": The image pull secret is required for accessing Solace's private GCR registry. See ",(0,i.jsx)(s.a,{href:"/#step-2-configure-image-pull-secret",children:"Configure Image Pull Secret"})," in the Getting Started guide."]}),"\n"]}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Component"}),(0,i.jsx)(s.th,{children:"Docker Hub Tag"}),(0,i.jsx)(s.th,{children:"GCR Tag"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"PostgreSQL"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"18.0"})}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"18.0-trixie"})})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"SeaweedFS"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"3.97"})}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"3.97-compliant"})})]})]})]}),"\n",(0,i.jsx)(s.h4,{id:"custom-or-self-managed-images",children:"Custom or Self-Managed Images"}),"\n",(0,i.jsx)(s.p,{children:"For advanced use cases where you need to use custom images (e.g., self-hosted registries, modified images, or air-gapped environments), you can override the full image configuration:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'persistence-layer:\n  postgresql:\n    image:\n      registry: "my-registry.example.com"  # Custom registry (overrides global.imageRegistry)\n      repository: "my-org/custom-postgres" # Custom image name (default: "postgres")\n      tag: "18.0-custom"                   # Custom tag (default: "18.0")\n  seaweedfs:\n    image:\n      registry: "my-registry.example.com"\n      repository: "my-org/custom-seaweedfs" # Default: "chrislusf/seaweedfs"\n      tag: "3.97-custom"                    # Default: "3.97"\n'})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Image Configuration Precedence:"})}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"persistence-layer.[postgresql|seaweedfs].image.registry"})," (if set) takes precedence over ",(0,i.jsx)(s.code,{children:"global.imageRegistry"})]}),"\n",(0,i.jsx)(s.li,{children:"If neither registry is set, images pull from Docker Hub by default"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"repository"})," and ",(0,i.jsx)(s.code,{children:"tag"})," are always component-specific and can be overridden independently"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"storage-class-configuration",children:"Storage Class Configuration"}),"\n",(0,i.jsx)(s.p,{children:"By default, the bundled persistence uses the cluster's default storage class. To specify a custom storage class:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'persistence-layer:\n  postgresql:\n    persistence:\n      storageClassName: "gp3"  # e.g., gp3 for AWS EBS\n      size: "10Gi"  # Default: 10Gi\n  seaweedfs:\n    persistence:\n      storageClassName: "gp3"\n      size: "20Gi"  # Default: 20Gi\n'})}),"\n",(0,i.jsx)(s.h3,{id:"important-caveats",children:"Important Caveats"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"PVCs persist after uninstall"}),": When you run ",(0,i.jsx)(s.code,{children:"helm uninstall"}),", the PersistentVolumeClaims (PVCs) are not automatically deleted. This is by design to prevent accidental data loss. To fully clean up:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"kubectl delete pvc -l app.kubernetes.io/namespace-id=<your-namespace-id>\n"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Single instance only"}),": The bundled persistence deploys single-instance databases with no high availability or automatic failover."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"No automatic backups"}),": You are responsible for implementing backup strategies for the bundled databases."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Docker Hub rate limits"}),": If not using a private registry, you may encounter Docker Hub rate limits during image pulls."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"option-2-external-persistence-production-recommended",children:"Option 2: External Persistence (Production Recommended)"}),"\n",(0,i.jsx)(s.p,{children:"For production deployments, use managed PostgreSQL and S3-compatible storage services for better scalability, reliability, and separation of concerns."}),"\n",(0,i.jsxs)(s.p,{children:["When using external persistence, the bundled persistence layer is disabled by default (",(0,i.jsx)(s.code,{children:"global.persistence.enabled: false"}),")."]}),"\n",(0,i.jsx)(s.h3,{id:"database-requirements",children:"Database Requirements"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"PostgreSQL version 17 or higher"}),"\n",(0,i.jsxs)(s.li,{children:["Admin credentials with ",(0,i.jsx)(s.code,{children:"SUPERUSER"})," privileges (recommended) or at minimum ",(0,i.jsx)(s.code,{children:"CREATEROLE"})," and ",(0,i.jsx)(s.code,{children:"CREATEDB"})]}),"\n",(0,i.jsx)(s.li,{children:"SAM's init container uses admin credentials to automatically create users and databases for the application and any deployed agents"}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"basic-external-configuration",children:"Basic External Configuration"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'global:\n  persistence:\n    enabled: false  # Default, can be omitted\n    namespaceId: "my-sam-instance"\n\ndataStores:\n  database:\n    protocol: "postgresql+psycopg2"\n    host: "your-postgres-host"\n    port: "5432"\n    adminUsername: "your-db-admin-user"\n    adminPassword: "your-db-admin-password"\n    applicationPassword: "your-secure-app-password"  # REQUIRED: Password for all app database users\n  s3:\n    endpointUrl: "your-s3-endpoint-url"\n    bucketName: "your-bucket-name"\n    accessKey: "your-s3-access-key"\n    secretKey: "your-s3-secret-key"\n'})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Important"}),": The ",(0,i.jsx)(s.code,{children:"applicationPassword"})," field is ",(0,i.jsx)(s.strong,{children:"required"})," when using external persistence. This single password will be used for all database users created by SAM (webui, orchestrator, platform, and all agents)."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Password Rotation Limitation"}),": Once database users are created for a given ",(0,i.jsx)(s.code,{children:"namespaceId"}),", the ",(0,i.jsx)(s.code,{children:"applicationPassword"})," cannot be changed. If you need to change the password, you must either use a new ",(0,i.jsx)(s.code,{children:"namespaceId"})," (which creates new databases and users), or manually update the passwords directly in the database."]}),"\n",(0,i.jsx)(s.h3,{id:"provider-specific-examples",children:"Provider-Specific Examples"}),"\n",(0,i.jsx)(s.h4,{id:"supabase-with-connection-pooler",children:"Supabase with Connection Pooler"}),"\n",(0,i.jsx)(s.p,{children:"If using Supabase with the connection pooler (required for IPv4 networks):"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'dataStores:\n  database:\n    protocol: "postgresql+psycopg2"\n    host: "aws-1-us-east-1.pooler.supabase.com"\n    port: "5432"\n    adminUsername: "postgres"\n    adminPassword: "your-supabase-postgres-password"\n    applicationPassword: "your-secure-app-password"\n    supabaseTenantId: "your-project-id"  # Extract from connection string\n  s3:\n    endpointUrl: "https://your-project-id.storage.supabase.co/storage/v1/s3"\n    bucketName: "your-bucket-name"\n    accessKey: "your-supabase-s3-access-key"\n    secretKey: "your-supabase-s3-secret-key"\n'})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Note"}),": If using Supabase's Direct Connection with IPv4 addon, omit the ",(0,i.jsx)(s.code,{children:"supabaseTenantId"})," field."]}),"\n",(0,i.jsx)(s.h4,{id:"aws-rds--s3",children:"AWS RDS + S3"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'dataStores:\n  database:\n    protocol: "postgresql+psycopg2"\n    host: "mydb.abc123.us-east-1.rds.amazonaws.com"\n    port: "5432"\n    adminUsername: "postgres"\n    adminPassword: "your-rds-password"\n    applicationPassword: "your-secure-app-password"\n  s3:\n    endpointUrl: "https://s3.us-east-1.amazonaws.com"\n    bucketName: "my-sam-artifacts"\n    accessKey: "AKIAIOSFODNN7EXAMPLE"\n    secretKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"\n'})}),"\n",(0,i.jsx)(s.h4,{id:"neondb",children:"NeonDB"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'dataStores:\n  database:\n    protocol: "postgresql+psycopg2"\n    host: "ep-cool-name-123456.us-east-2.aws.neon.tech"\n    port: "5432"\n    adminUsername: "neondb_owner"\n    adminPassword: "your-neon-password"\n    applicationPassword: "your-secure-app-password"\n  s3:\n    # Configure your preferred S3-compatible storage\n    endpointUrl: "https://s3.amazonaws.com"\n    bucketName: "my-sam-artifacts"\n    accessKey: "your-access-key"\n    secretKey: "your-secret-key"\n'})}),"\n",(0,i.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(s.h3,{id:"init-container-stuck-in-pendingcrashloopbackoff",children:"Init Container Stuck in Pending/CrashLoopBackOff"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Symptoms"}),": The ",(0,i.jsx)(s.code,{children:"agent-mesh-core"})," pod shows init containers waiting or failing."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Common causes"}),":"]}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Image pull failures"}),": Check if using GCR registry without specifying GCR-specific image tags"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Storage class issues"}),": Verify the storage class exists and can provision volumes"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Database connectivity"}),": For external persistence, verify network connectivity to the database"]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Debug commands"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"# Check pod status and events\nkubectl describe pod -l app.kubernetes.io/name=solace-agent-mesh\n\n# Check init container logs\nkubectl logs <pod-name> -c init-db-provision\n\n# Verify PVC status\nkubectl get pvc\n"})}),"\n",(0,i.jsx)(s.h3,{id:"pvc-stuck-in-pending",children:"PVC Stuck in Pending"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Symptoms"}),": PersistentVolumeClaims remain in ",(0,i.jsx)(s.code,{children:"Pending"})," state."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Common causes"}),":"]}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"No default storage class configured"}),"\n",(0,i.jsx)(s.li,{children:"Specified storage class doesn't exist"}),"\n",(0,i.jsx)(s.li,{children:"Storage provisioner issues"}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Solution"}),": Specify an existing storage class explicitly:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:'persistence-layer:\n  postgresql:\n    persistence:\n      storageClassName: "your-storage-class"\n'})}),"\n",(0,i.jsx)(s.h3,{id:"docker-hub-rate-limit-errors",children:"Docker Hub Rate Limit Errors"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Symptoms"}),": Image pull errors mentioning rate limits."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Solution"}),": Use Solace's private GCR registry (see ",(0,i.jsx)(s.a,{href:"#image-registry-configuration",children:"Image Registry Configuration"}),")."]})]})}function p(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>o});var r=n(6540);const i={},t=r.createContext(i);function a(e){const s=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);