{{- /*
Create persistence secret for the main container.
This secret is ALWAYS needed (both deployer and standalone modes).

In standalone mode with existingSecrets: skip creation, user provides their own.
In all other cases: create the secret using helper functions that handle both modes.
*/ -}}
{{- $skipDatabase := and (eq .Values.deploymentMode "standalone") .Values.persistence.existingSecrets.database }}
{{- $skipS3 := and (eq .Values.deploymentMode "standalone") .Values.persistence.existingSecrets.s3 }}
{{- if not (and $skipDatabase $skipS3) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "sam.fullname" . }}-persistence
  labels:
    {{- include "sam.labels" . | nindent 4 }}
type: Opaque
data:
  DATABASE_URL: {{ include "sam.postgresql.databaseUrl" . | b64enc }}
  S3_ENDPOINT_URL: {{ include "sam.s3.url" . | b64enc }}
  S3_BUCKET_NAME: {{ include "sam.s3.bucketName" . | b64enc }}
  AWS_ACCESS_KEY_ID: {{ include "sam.s3.accessKey" . | b64enc }}
  AWS_SECRET_ACCESS_KEY: {{ include "sam.s3.secretKey" . | b64enc }}
  AWS_REGION: {{ .Values.persistence.s3.region | default "us-east-1" | b64enc }}
{{- end }}